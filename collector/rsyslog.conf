# Basic configuration
module(load="imudp")    # UDP input module
module(load="imtcp")    # TCP input module
 #module(load="omfile") # File output module (Replaced by omhttp)
 module(load="omhttp")   # HTTP output module

# Global settings
global(
    workDirectory="/var/spool/rsyslog"
    maxMessageSize="64k"
)

# Set up TCP and UDP inputs on port 5514
input(type="imudp" port="5514")
input(type="imtcp" port="5514")

# Template for JSON output
template(name="JsonLogFormat" type="list") {
    constant(value="{")
    constant(value="\"timestamp\":\"")
    property(name="timereported" dateFormat="rfc3339")
    constant(value="\",")
    constant(value="\"source\":\"")
    property(name="hostname")
    constant(value="\",")
    constant(value="\"facility\":\"")
    property(name="syslogfacility-text")
    constant(value="\",")
    constant(value="\"severity\":\"")
    property(name="syslogseverity-text")
    constant(value="\",")
    constant(value="\"tag\":\"")
    property(name="syslogtag" format="json")
    constant(value="\",")
    constant(value="\"message\":\"")
    property(name="msg" format="json")
    constant(value="\"}")
    constant(value="\n")
}

# Write all messages to the JSON file
#action(
#    type="omfile"
#    file="/var/log/collector/syslog.json"
#    template="JsonLogFormat"
#    flushOnTXEnd="on"
#    asyncWriting="off"
#    ioBufferSize="64k"
# )

# Forward all messages via HTTP to the local FastAPI endpoint
action(
    type="omhttp"
    server="localhost"
    port="8000"
    restpath="/logs"
    template="JsonLogFormat"
    usehttps="off"
    contenttype="application/json"
    batch="on"                 # Enable batching
    batch.maxsize="100"        # Max messages per batch
    action.resumeRetryCount="-1" # Retry indefinitely if endpoint is down
    action.resumeInterval="30"   # Wait 30 seconds between retries
)

# Set file permissions
$FileCreateMode 0644
$DirCreateMode 0755
$Umask 0022